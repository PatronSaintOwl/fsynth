var _fas=!1,_fas_timeout,_fas_ws,_FAS_ENABLE=0,_FAS_DISABLE=1,_FAS_AUDIO_INFOS=2,_FAS_GAIN_INFOS=3,_FAS_FRAME=4,_FAS_CHN_INFOS=5,_FAS_ACTION=6,_FAS_ACTION_RELOAD=0,_FAS_ACTION_RETRIGGER=1,_getAudioInfosBuffer=function(e){if(!(e.h<=0||e.octaves<=0||e.base_freq<=0)){var n=new ArrayBuffer(32),t=new Uint8Array(n,0,1),a=new Uint32Array(n,8,3),_=new Float64Array(n,24);return t[0]=0,a[0]=e.h,a[1]=e.octaves,a[2]=e.float_data===!0?1:0,_[0]=e.base_freq,n}},_getGainBuffer=function(e){var n=new ArrayBuffer(16),t=new Uint8Array(n,0,1),a=new Float64Array(n,8);return t[0]=2,a[0]=e.gain,n},_sendAudioInfos=function(e){if(_fas){if(1!==_fas_ws.readyState)return void setTimeout(_sendAudioInfos,1e3,e);try{_fas_ws.send(_getAudioInfosBuffer(e))}finally{}}},_sendGain=function(e){if(_fas){if(1!==_fas_ws.readyState)return void setTimeout(_sendGain,1e3,e);try{_fas_ws.send(_getGainBuffer(e))}finally{}}},_sendAction=function(e){if(_fas){var n,t,a;if(e.type===_FAS_ACTION_RELOAD?(n=new ArrayBuffer(16),t=new Uint8Array(n,0,2),t[0]=4,t[1]=e.type):e.type===_FAS_ACTION_RETRIGGER&&(n=new ArrayBuffer(24),t=new Uint8Array(n,0,2),a=new Uint32Array(n,8,2),t[0]=4,t[1]=e.type,a[0]=e.chn,a[1]=e.note),1!==_fas_ws.readyState)return void setTimeout(_sendAction,1e3,e);try{_fas_ws.send(n)}finally{}}},_sendChnInfos=function(e){if(_fas){if(1!==_fas_ws.readyState)return void setTimeout(_sendChnInfos,1e3,e);var n,t=new ArrayBuffer(16+32*e.length),a=new Uint8Array(t,0,1),_=new Uint32Array(t,8,1),s=0;for(a[0]=3,_[0]=e.length,s=0;s<e.length;s+=1)a=new Uint32Array(t,16+32*s,2),n=new Float64Array(t,24+32*s),a[0]=0,a[1]=0,n[0]=0,n[1]=0,n[2]=0,e[s][0]&&(a[0]=e[s][0]),e[s][1]&&(a[1]=e[s][1]),e[s][2]&&(n[0]=e[s][2]),e[s][3]&&(n[1]=e[s][3]),e[s][4]&&(n[2]=e[s][4]);try{_fas_ws.send(t)}finally{}}},_sendFrame=function(e,n,t){if(1===_fas_ws.readyState){var a,_,s,r,f,o;if(t?(a=new Float32Array(e[0]),f=16+4*a.length*e.length):(a=new Uint8Array(e[0]),f=16+a.length*e.length),_=new ArrayBuffer(f),s=new Uint8Array(_,0,1),r=new Uint32Array(_,8,2),o=0,s[0]=1,r[0]=e.length,r[1]=n===!0?1:0,t)for(o=0;o<e.length;o+=1)s=new Float32Array(_,16+4*a.length*o,a.length),s.set(new Float32Array(e[o]));else for(o=0;o<e.length;o+=1)s=new Uint8Array(_,16+a.length*o,a.length),s.set(new Uint8Array(e[o]));try{_fas_ws.send(_)}finally{}}},_disconnect=function(){_fas_ws&&_fas_ws.close(4e3),clearTimeout(_fas_timeout)},_connect=function(e){_fas_ws=new WebSocket("ws://"+e.address),_fas_ws.binaryType="arraybuffer",_fas_ws.onopen=function(){postMessage({status:"open"})},_fas_ws.onerror=function(e){postMessage({status:"error"})},_fas_ws.onmessage=function(e){var n=new Float64Array(e.data);postMessage({status:"streamload",load:n})},_fas_ws.onclose=function(n){_fas&&4e3!==n.code&&(postMessage({status:"close"}),clearTimeout(_fas_timeout),_fas_timeout=setTimeout(_connect,5e3,e))}};self.onmessage=function(e){"use strict";var n=e.data,t=n.cmd,a=n.arg;t===_FAS_ENABLE?(_fas=!0,_connect(a)):t===_FAS_DISABLE?(_fas=!1,_disconnect()):t===_FAS_AUDIO_INFOS?_sendAudioInfos(a):t===_FAS_GAIN_INFOS?_sendGain(a):t===_FAS_FRAME?_sendFrame(a,n.mono,n.float):t===_FAS_CHN_INFOS?_sendChnInfos(a):t===_FAS_ACTION&&_sendAction(a)};